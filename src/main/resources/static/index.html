<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conexión - Gestión de Internet</title>
    <!-- Incluye Tailwind CSS para un estilo rápido y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #eef2ff 100%); /* New gradient background */
        }
        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .screen.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Styles from new design for menu cards */
        .menu-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2.5rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .menu-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .menu-card .icon {
            width: 3.5rem;
            height: 3.5rem;
            margin-bottom: 0.75rem;
            stroke-width: 2.5;
        }
        /* Estilos para el botón "Primary Filled Button" */
        .primary-blue-button {
            background-color: #2563EB; /* Azul 600 */
            color: #ffffff; /* Texto blanco */
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); /* Sombra inicial */
        }

        .primary-blue-button:hover {
            background-color: #1D4ED8; /* Azul 700 al pasar el ratón */
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4); /* Sombra más pronunciada */
            transform: translateY(-2px); /* Ligeramente elevado */
        }

        .primary-blue-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
        }

        /* Estilos para el botón secundario "Regresar" */
        .secondary-button {
            background-color: #cbd5e1; /* Gris claro */
            color: #334155; /* Gris oscuro */
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .secondary-button:hover {
            background-color: #94a3b8; /* Gris medio */
            color: #f8fafc; /* Blanco casi */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Estilos específicos para los campos de entrada al enfocarse */
        input:focus, select:focus {
            border-color: #2563EB !important; /* Azul 600 */
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3) !important; /* Anillo de enfoque azul */
            outline: none !important;
        }
    </style>
</head>
<body class="bg-indigo-50 p-8">

    <!-- Contenedor principal de la aplicación -->
    <div class="w-full max-w-5xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10">

        <!-- Pantalla de inicio de sesión -->
        <div id="login-screen" class="screen active">
            <!-- Contenedor Principal: Tarjeta de Login -->
            <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden transform transition duration-500 hover:shadow-2xl mx-auto mt-10">

                <!-- Header con Banner de Color Frío -->
                <div class="bg-blue-600 p-8 flex flex-col items-center">
                    <i data-lucide="shield-check" class="w-12 h-12 text-white mb-2"></i>
                    <h1 class="text-3xl font-extrabold text-white">Conexión</h1>
                    <p class="text-white text-opacity-80 mt-1">Gestión de Internet</p>
                </div>

                <!-- Formulario de Inicio de Sesión -->
                <form id="loginForm" class="p-8 sm:p-10">
                    
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Inicie Sesión en su Cuenta</h2>

                    <!-- Campo de Usuario -->
                    <div class="mb-5">
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                            <i data-lucide="user" class="w-4 h-4 mr-2 text-blue-600"></i>
                            Nombre de Usuario
                        </label>
                        <div class="relative">
                            <input type="text" id="username" name="username" placeholder="Ingrese su usuario"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm"
                                   required>
                        </div>
                    </div>

                    <!-- Campo de Contraseña -->
                    <div class="mb-8">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                            <i data-lucide="lock" class="w-4 h-4 mr-2 text-blue-600"></i>
                            Contraseña
                        </label>
                        <div class="relative">
                            <input type="password" id="password" name="password" placeholder="••••••••"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm"
                                   required>
                        </div>
                    </div>

                    <!-- Botón de Ingreso -->
                    <button type="button" onclick="handleLogin()"
                            class="w-full py-3 bg-cyan-500 text-white font-bold rounded-lg shadow-md hover:bg-cyan-600 transition duration-200 focus:ring-4 focus:ring-cyan-300 focus:outline-none flex items-center justify-center">
                        <i data-lucide="log-in" class="w-5 h-5 mr-2"></i>
                        Ingresar
                    </button>
                    
                    <!-- Mensaje de Estado -->
                    <div id="login-message" class="mt-4 p-3 rounded-lg text-center hidden text-sm font-medium"></div>

                </form>
            </div>
        </div>

        <!-- Pantalla del Dashboard (Menú Principal) -->
        <div id="dashboard-screen" class="screen">
            <!-- Encabezado y Botón de Sesión -->
            <header class="flex justify-between items-start mb-8 border-b pb-4">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">Menú Principal</h1>
                    <p class="text-gray-500 mt-1">Bienvenido. Gestiona la aplicación.</p>
                </div>
                <!-- Botón de Cerrar Sesión con funcionalidad original -->
                <button onclick="handleLogout()" 
                        class="ml-4 px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-200 shadow-md flex items-center">
                    <i data-lucide="log-out" class="w-5 h-5 mr-1"></i>
                    Cerrar Sesión
                </button>
            </header>
            
            <!-- Grid de Opciones de Menú -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">

                <!-- Opción 1: Gestión de Usuarios -->
                <button onclick="loadUsersAndShowScreen()" class="menu-card bg-blue-700 hover:bg-blue-800">
                    <i data-lucide="users" class="icon"></i>
                    <span class="text-xl font-bold">Gestión de Usuarios</span>
                    <span class="text-sm opacity-80">Crear, editar o eliminar cuentas.</span>
                </button>

                <!-- Opción 2: Gestión de Clientes -->
                <button onclick="loadClientesAndShowScreen()" class="menu-card bg-teal-600 hover:bg-teal-700">
                    <i data-lucide="briefcase" class="icon"></i>
                    <span class="text-xl font-bold">Gestión de Clientes</span>
                    <span class="text-sm opacity-80">Visualizar y administrar datos de clientes.</span>
                </button>

                <!-- Opción 3: Gestión de Planes -->
                <button onclick="loadPlansAndShowScreen()" class="menu-card bg-sky-500 hover:bg-sky-600">
                    <i data-lucide="package" class="icon"></i>
                    <span class="text-xl font-bold">Gestión de Planes</span>
                    <span class="text-sm opacity-80">Configuración de paquetes de servicio.</span>
                </button>

                <!-- Opción 4: Clasificación de Dispositivos -->
                <button onclick="loadClasificacionesAndShowScreen()" class="menu-card bg-indigo-600 hover:bg-indigo-700">
                    <i data-lucide="cpu" class="icon"></i>
                    <span class="text-xl font-bold">Clasificación de Dispositivos</span>
                    <span class="text-sm opacity-80">Categorización de equipos.</span>
                </button>

                <!-- Opción 5: Gestión de Dispositivos -->
                <button onclick="loadDispositivosAndShowScreen()" class="menu-card bg-cyan-600 hover:bg-cyan-700">
                    <i data-lucide="router" class="icon"></i>
                    <span class="text-xl font-bold">Gestión de Dispositivos</span>
                    <span class="text-sm opacity-80">Alta y mantenimiento de equipos.</span>
                </button>

                <!-- Opción 6: Gestión de Servicios -->
                <button onclick="loadServiciosAndShowScreen()" class="menu-card bg-blue-500 hover:bg-blue-600">
                    <i data-lucide="globe" class="icon"></i>
                    <span class="text-xl font-bold">Gestión de Servicios</span>
                    <span class="text-sm opacity-80">Definición de servicios ofrecidos.</span>
                </button>

                <!-- Opción 7: Registro de Pagos -->
                <button onclick="loadPagosAndShowScreen()" class="menu-card bg-emerald-600 hover:bg-emerald-700">
                    <i data-lucide="credit-card" class="icon"></i>
                    <span class="text-xl font-bold">Registro de Pagos</span>
                    <span class="text-sm opacity-80">Registro y seguimiento de transacciones.</span>
                </button>
            </div>
        </div>

        <!-- Pantalla de Gestión de Usuarios -->
        <div id="users-screen" class="screen">
            <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl relative">
                <!-- Botón de Regresar -->
                <button onclick="showScreen('dashboard-screen')" class="secondary-button absolute top-6 right-6">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Regresar
                </button>

                <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b-2 border-blue-500 pb-3 flex items-center gap-3">
                    <i data-lucide="users" class="w-8 h-8 text-blue-600"></i> Panel de Gestión de Usuarios
                </h1>

                <!-- Formulario de Creación/Edición de Usuario -->
                <div class="mb-10 p-6 bg-slate-50 rounded-xl shadow-inner border border-slate-200">
                    <h2 class="text-xl font-bold text-gray-700 mb-5 flex items-center gap-2">
                        <i data-lucide="user-plus" class="w-5 h-5 text-blue-500"></i> Detalles del Usuario
                    </h2>
                    
                    <form id="user-form" class="space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                            <!-- Campo Nombre -->
                            <div>
                                <label for="user-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                                <input type="text" id="user-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border" placeholder="Ej: Juan" required>
                            </div>
                            
                            <!-- Campo Apellido -->
                            <div>
                                <label for="user-lastname" class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
                                <input type="text" id="user-lastname" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border" placeholder="Ej: Pérez" required>
                            </div>

                            <!-- Campo Nombre de Usuario -->
                            <div>
                                <label for="user-username" class="block text-sm font-medium text-gray-700 mb-1">Nombre de Usuario</label>
                                <input type="text" id="user-username" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border" placeholder="Ej: jperez_admin" required>
                            </div>

                            <!-- Campo Contraseña -->
                            <div>
                                <label for="user-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                                <input type="password" id="user-password" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border" placeholder="Mínimo 8 caracteres">
                            </div>
                        </div>

                        <!-- Campo Rol (Ahora ocupa todo el ancho si la cuadrícula es 2) -->
                        <div class="md:col-span-2">
                            <label for="user-role" class="block text-sm font-medium text-gray-700 mb-1">Rol</label>
                            <select id="user-role" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border bg-white">
                                <option value="ADMINISTRADOR">Administrador</option>
                                <option value="TECNICO">Técnico</option>
                            </select>
                        </div>
                        
                        <!-- Botón de Guardar con el nuevo diseño de relleno -->
                        <div class="pt-6 text-right">
                            <button type="button" id="save-button" class="primary-blue-button" onclick="handleSaveUser()">
                                <i data-lucide="save" class="w-5 h-5"></i>
                                <span id="save-button-text">Guardar Usuario</span>
                            </button>
                            <button type="button" id="cancel-edit-button" onclick="cancelEdit()" class="secondary-button ml-2 hidden">
                                Cancelar Edición
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Mensaje de estado -->
                <div id="status-message" class="hidden p-3 rounded-lg text-center font-medium shadow-md mb-8"></div>

                <!-- Lista de Usuarios -->
                <h2 class="text-2xl font-bold text-gray-800 mb-5 mt-8 border-b-2 border-slate-300 pb-2 flex items-center gap-3">
                    <i data-lucide="list-checks" class="w-6 h-6 text-slate-600"></i> Usuarios Registrados
                </h2>
                <div id="users-list" class="space-y-4">
                    <!-- Los usuarios se añadirán aquí con JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Pantalla de Gestión de Clientes -->
        <div id="clients-screen" class="screen">
            <div class="flex justify-between items-center mb-6 border-b-2 border-blue-500 pb-3">
                <h1 class="text-3xl font-extrabold text-gray-800 flex items-center gap-3"><i data-lucide="briefcase" class="w-8 h-8 text-blue-600"></i>Gestión de Clientes</h1>
                <button onclick="showScreen('dashboard-screen')" class="secondary-button"><i data-lucide="arrow-left" class="w-4 h-4"></i>Regresar</button>
            </div>
            <div class="bg-slate-50 rounded-xl shadow-inner border border-slate-200 p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-700 mb-5 flex items-center gap-2"><i data-lucide="user-plus" class="w-5 h-5 text-blue-500"></i>Crear/Editar Cliente</h2>
                <form id="cliente-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Nombre</label><input type="text" id="cliente-form-nombre" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Apellido</label><input type="text" id="cliente-form-apellido" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Teléfono</label><input type="text" id="cliente-form-telefono" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Dirección</label><input type="text" id="cliente-form-direccion" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">DPI</label><input type="text" id="cliente-form-dpi" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Estado</label><select id="cliente-form-estado" class="w-full mt-1 px-3 py-2 border rounded-md"><option value="ACTIVO">Activo</option><option value="INACTIVO">Inactivo</option></select></div>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button id="cliente-form-button" type="button" onclick="handleSaveCliente()" class="primary-blue-button w-full"><i data-lucide="save" class="w-5 h-5"></i>Guardar Cliente</button>
                        <button id="cancel-edit-cliente-button" type="button" onclick="cancelEditCliente()" class="secondary-button w-full hidden"><i data-lucide="x" class="w-5 h-5"></i>Cancelar</button>
                    </div>
                </form>
                <div id="cliente-form-message" class="hidden p-4 rounded-md text-center text-sm mt-4"></div>
            </div>

            <!-- Formulario de Búsqueda -->
            <div class="mb-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-5 flex items-center gap-3"><i data-lucide="search" class="w-6 h-6 text-slate-600"></i>Buscar Clientes</h2>
                <div class="flex space-x-2">
                    <input type="text" id="cliente-search-query" class="w-full px-3 py-2 border rounded-md" placeholder="Buscar por nombre, DPI o teléfono...">
                    <button onclick="handleSearchClientes()" class="primary-blue-button"><i data-lucide="search" class="w-5 h-5"></i>Buscar</button>
                    <button onclick="loadClientes()" class="secondary-button"><i data-lucide="rotate-cw" class="w-5 h-5"></i>Limpiar</button>
                </div>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-5 mt-8 border-b-2 border-slate-300 pb-2 flex items-center gap-3"><i data-lucide="list-checks" class="w-6 h-6 text-slate-600"></i>Listado de Clientes</h2>
            <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dirección</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DPI</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th></tr>
                    </thead>
                    <tbody id="cliente-list-body" class="bg-white divide-y divide-gray-200">
                        <!-- Client list will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pantalla de Gestión de Planes -->
        <div id="plans-screen" class="screen">
            <div class="flex justify-between items-center mb-6 border-b-2 border-blue-500 pb-3">
                <h1 class="text-3xl font-extrabold text-gray-800 flex items-center gap-3"><i data-lucide="package" class="w-8 h-8 text-blue-600"></i>Gestión de Planes</h1>
                <button onclick="showScreen('dashboard-screen')" class="secondary-button"><i data-lucide="arrow-left" class="w-4 h-4"></i>Regresar</button>
            </div>
            <div class="bg-slate-50 rounded-xl shadow-inner border border-slate-200 p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-700 mb-5 flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5 text-blue-500"></i>Crear/Editar Plan</h2>
                <form id="plan-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nombre del Plan</label>
                        <input type="text" id="plan-form-nombre" class="w-full mt-1 px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Velocidad</label>
                        <input type="text" id="plan-form-velocidad" class="w-full mt-1 px-3 py-2 border rounded-md" placeholder="Ej: 50 Mbps">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Costo Mensual</label>
                        <input type="number" id="plan-form-costo" class="w-full mt-1 px-3 py-2 border rounded-md">
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button id="plan-form-button" type="button" onclick="handleSavePlan()" class="primary-blue-button w-full"><i data-lucide="save" class="w-5 h-5"></i>Guardar Plan</button>
                        <button id="cancel-edit-plan-button" type="button" onclick="cancelEditPlan()" class="secondary-button w-full hidden"><i data-lucide="x" class="w-5 h-5"></i>Cancelar</button>
                    </div>
                </form>
                <div id="plan-form-message" class="hidden p-4 rounded-md text-center text-sm mt-4"></div>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-5 mt-8 border-b-2 border-slate-300 pb-2 flex items-center gap-3"><i data-lucide="list-checks" class="w-6 h-6 text-slate-600"></i>Listado de Planes</h2>
            <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Velocidad</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Costo</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th></tr>
                    </thead>
                    <tbody id="plan-list-body" class="bg-white divide-y divide-gray-200">
                        <!-- Plan list will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pantalla de Clasificación de Dispositivos -->
        <div id="device-class-screen" class="screen">
            <div class="flex justify-between items-center mb-6 border-b-2 border-blue-500 pb-3">
                <h1 class="text-3xl font-extrabold text-gray-800 flex items-center gap-3"><i data-lucide="cpu" class="w-8 h-8 text-blue-600"></i>Clasificación de Dispositivos</h1>
                <button onclick="showScreen('dashboard-screen')" class="secondary-button"><i data-lucide="arrow-left" class="w-4 h-4"></i>Regresar</button>
            </div>
            <div class="bg-slate-50 rounded-xl shadow-inner border border-slate-200 p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-700 mb-5 flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5 text-blue-500"></i>Nueva/Editar Clasificación</h2>
                <form id="clasificacion-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nombre de la Clasificación</label>
                        <input type="text" id="clasificacion-form-nombre" class="w-full mt-1 px-3 py-2 border rounded-md">
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button id="clasificacion-form-button" type="button" onclick="handleSaveClasificacion()" class="primary-blue-button w-full"><i data-lucide="save" class="w-5 h-5"></i>Guardar</button>
                        <button id="cancel-edit-clasificacion-button" type="button" onclick="cancelEditClasificacion()" class="secondary-button w-full hidden"><i data-lucide="x" class="w-5 h-5"></i>Cancelar</button>
                    </div>
                </form>
                <div id="clasificacion-form-message" class="hidden p-4 rounded-md text-center text-sm mt-4"></div>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-5 mt-8 border-b-2 border-slate-300 pb-2 flex items-center gap-3"><i data-lucide="list-checks" class="w-6 h-6 text-slate-600"></i>Clasificaciones Existentes</h2>
            <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th></tr>
                    </thead>
                    <tbody id="clasificacion-list-body" class="bg-white divide-y divide-gray-200">
                        <!-- Classification list will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pantalla de Gestión de Dispositivos -->
        <div id="devices-screen" class="screen">
            <div class="flex justify-between items-center mb-6 border-b-2 border-blue-500 pb-3">
                <h1 class="text-3xl font-extrabold text-gray-800 flex items-center gap-3"><i data-lucide="router" class="w-8 h-8 text-blue-600"></i>Gestión de Dispositivos</h1>
                <button onclick="showScreen('dashboard-screen')" class="secondary-button"><i data-lucide="arrow-left" class="w-4 h-4"></i>Regresar</button>
            </div>
            <div class="bg-slate-50 rounded-xl shadow-inner border border-slate-200 p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-700 mb-5 flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5 text-blue-500"></i>Crear/Editar Dispositivo</h2>
                <form id="dispositivo-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Modelo</label><input type="text" id="dispositivo-form-modelo" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Dirección MAC</label><input type="text" id="dispositivo-form-mac" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">IP Local</label><input type="text" id="dispositivo-form-ip" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Contraseña WiFi</label><input type="text" id="dispositivo-form-wifi" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">SSID</label><input type="text" id="dispositivo-form-ssid" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Clasificación</label><select id="dispositivo-form-clasificacion" class="w-full mt-1 px-3 py-2 border rounded-md"></select></div>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button id="dispositivo-form-button" type="button" onclick="handleSaveDispositivo()" class="primary-blue-button w-full"><i data-lucide="save" class="w-5 h-5"></i>Guardar Dispositivo</button>
                        <button id="cancel-edit-dispositivo-button" type="button" onclick="cancelEditDispositivo()" class="secondary-button w-full hidden"><i data-lucide="x" class="w-5 h-5"></i>Cancelar</button>
                    </div>
                </form>
                <div id="dispositivo-form-message" class="hidden p-4 rounded-md text-center text-sm mt-4"></div>
            </div>

            <!-- Formulario de Búsqueda -->
            <div class="mb-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-5 flex items-center gap-3"><i data-lucide="search" class="w-6 h-6 text-slate-600"></i>Buscar Dispositivos</h2>
                <div class="flex space-x-2">
                    <input type="text" id="dispositivo-search-query" class="w-full px-3 py-2 border rounded-md" placeholder="Buscar por modelo o MAC...">
                    <button onclick="handleSearchDispositivos()" class="primary-blue-button"><i data-lucide="search" class="w-5 h-5"></i>Buscar</button>
                    <button onclick="loadDispositivos()" class="secondary-button"><i data-lucide="rotate-cw" class="w-5 h-5"></i>Limpiar</button>
                </div>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-5 mt-8 border-b-2 border-slate-300 pb-2 flex items-center gap-3"><i data-lucide="list-checks" class="w-6 h-6 text-slate-600"></i>Listado de Dispositivos</h2>
            <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modelo</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dirección MAC</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clasificación</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th></tr>
                    </thead>
                    <tbody id="dispositivo-list-body" class="bg-white divide-y divide-gray-200">
                        <!-- Device list will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pantalla de Gestión de Servicios -->
        <div id="services-screen" class="screen">
            <div class="flex justify-between items-center mb-6 border-b-2 border-blue-500 pb-3">
                <h1 class="text-3xl font-extrabold text-gray-800 flex items-center gap-3"><i data-lucide="globe" class="w-8 h-8 text-blue-600"></i>Gestión de Servicios</h1>
                <button onclick="showScreen('dashboard-screen')" class="secondary-button"><i data-lucide="arrow-left" class="w-4 h-4"></i>Regresar</button>
            </div>
            <div class="bg-slate-50 rounded-xl shadow-inner border border-slate-200 p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-700 mb-5 flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5 text-blue-500"></i>Crear/Editar Servicio</h2>
                <form id="servicio-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Cliente</label><select id="servicio-form-cliente" class="w-full mt-1 px-3 py-2 border rounded-md"></select></div>
                        <div><label class="block text-sm font-medium text-gray-700">Plan</label><select id="servicio-form-plan" class="w-full mt-1 px-3 py-2 border rounded-md"></select></div>
                        <div><label class="block text-sm font-medium text-gray-700">Dispositivo</label><select id="servicio-form-dispositivo" class="w-full mt-1 px-3 py-2 border rounded-md"></select></div>
                        <div><label class="block text-sm font-medium text-gray-700">Fecha de Activación</label><input type="date" id="servicio-form-fecha-activacion" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Próximo Pago</label><input type="date" id="servicio-form-proximo-pago" class="w-full mt-1 px-3 py-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Estado</label><select id="servicio-form-estado" class="w-full mt-1 px-3 py-2 border rounded-md"><option value="ACTIVO">Activo</option><option value="SUSPENDIDO">Suspendido</option></select></div>
                        <div><label class="block text-sm font-medium text-gray-700">Monto de Descuento</label><input type="number" id="servicio-form-descuento" class="w-full mt-1 px-3 py-2 border rounded-md" value="0"></div>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button id="servicio-form-button" type="button" onclick="handleSaveServicio()" class="primary-blue-button w-full"><i data-lucide="save" class="w-5 h-5"></i>Guardar Servicio</button>
                        <button id="cancel-edit-servicio-button" type="button" onclick="cancelEditServicio()" class="secondary-button w-full hidden"><i data-lucide="x" class="w-5 h-5"></i>Cancelar</button>
                    </div>
                </form>
                <div id="servicio-form-message" class="hidden p-4 rounded-md text-center text-sm mt-4"></div>
            </div>

            <!-- Formulario de Búsqueda -->
            <div class="mb-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-5 flex items-center gap-3"><i data-lucide="search" class="w-6 h-6 text-slate-600"></i>Buscar Servicios</h2>
                <div class="flex space-x-2">
                    <input type="text" id="servicio-search-query" class="w-full px-3 py-2 border rounded-md" placeholder="Buscar por cliente o MAC...">
                    <button onclick="handleSearchServicios()" class="primary-blue-button"><i data-lucide="search" class="w-5 h-5"></i>Buscar</button>
                    <button onclick="loadServicios()" class="secondary-button"><i data-lucide="rotate-cw" class="w-5 h-5"></i>Limpiar</button>
                </div>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-5 mt-8 border-b-2 border-slate-300 pb-2 flex items-center gap-3"><i data-lucide="list-checks" class="w-6 h-6 text-slate-600"></i>Listado de Servicios</h2>
            <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plan</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dispositivo</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MAC</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clasificación</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Próximo Pago</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descuento</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th></tr>
                    </thead>
                    <tbody id="servicio-list-body" class="bg-white divide-y divide-gray-200">
                        <!-- Service list will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pantalla de Registro de Pagos -->
        <div id="payments-screen" class="screen">
            <div class="flex justify-between items-center mb-6 border-b-2 border-blue-500 pb-3">
                <h1 class="text-3xl font-extrabold text-gray-800 flex items-center gap-3"><i data-lucide="credit-card" class="w-8 h-8 text-blue-600"></i>Gestión de Pagos</h1>
                <button onclick="showScreen('dashboard-screen')" class="secondary-button"><i data-lucide="arrow-left" class="w-4 h-4"></i>Regresar</button>
            </div>
            <div class="bg-slate-50 rounded-xl shadow-inner border border-slate-200 p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-700 mb-5 flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5 text-blue-500"></i>Registrar Pago</h2>
                <div class="space-y-4">
                    <div>
                        <label for="cliente_servicio" class="block text-sm font-medium text-gray-700">Cliente y Servicio</label>
                        <select id="cliente_servicio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            <!-- Options will be populated here -->
                        </select>
                    </div>
                    <div>
                        <label for="tipo_pago" class="block text-sm font-medium text-gray-700">Tipo de Pago</label>
                        <select id="tipo_pago" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            <option value="mes" selected>Cuota Mensual Completa</option>
                            <option value="dias">Días Específicos (por suspensión)</option>
                        </select>
                    </div>
                    <div id="dias-container" class="hidden">
                        <label for="dias_pagar" class="block text-sm font-medium text-gray-700">Días a pagar</label>
                        <input type="number" id="dias_pagar" name="dias_pagar" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Ingrese la cantidad de días" min="1">
                    </div>
                    <div>
                        <label for="monto_pagar" class="block text-sm font-medium text-gray-700">Monto a pagar</label>
                        <input type="text" id="monto_pagar" name="monto_pagar" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100 sm:text-sm p-2" readonly>
                    </div>
                    <div>
                        <label for="comentario" class="block text-sm font-medium text-gray-700">Comentario</label>
                        <textarea id="comentario" name="comentario" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Escriba un comentario sobre el pago..."></textarea>
                    </div>
                    <div class="flex items-center justify-center pt-4">
                        <button type="button" onclick="handleRegisterPago()" class="primary-blue-button w-full"><i data-lucide="save" class="w-5 h-5"></i>Registrar Pago</button>
                    </div>
                </div>
            </div>
            
            <!-- Formulario de Búsqueda -->
            <div class="mb-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-5 flex items-center gap-3"><i data-lucide="search" class="w-6 h-6 text-slate-600"></i>Buscar Pagos</h2>
                <div class="flex space-x-2">
                    <input type="text" id="pago-search-query" class="w-full px-3 py-2 border rounded-md" placeholder="Buscar por nombre de cliente o comentario...">
                    <button onclick="handleSearchPagos()" class="primary-blue-button"><i data-lucide="search" class="w-5 h-5"></i>Buscar</button>
                    <button onclick="loadPagos()" class="secondary-button"><i data-lucide="rotate-cw" class="w-5 h-5"></i>Limpiar</button>
                </div>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-5 mt-8 border-b-2 border-slate-300 pb-2 flex items-center gap-3"><i data-lucide="list-checks" class="w-6 h-6 text-slate-600"></i>Historial de Pagos</h2>
            <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Pago</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comentario</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th></tr>
                    </thead>
                    <tbody id="pago-history-body" class="bg-white divide-y divide-gray-200">
                        <!-- Payment history will be populated here -->
                    </tbody>
                </table>
            </div>
            <!-- Mensajes de alerta -->
            <div id="messageBox" class="hidden p-4 rounded-md text-center text-sm mt-4"></div>
        </div>

    </div>

    <script>
        // SCRIPT_REPLACEMENT_MARKER
        // Variable global para almacenar el token JWT
        let jwtToken = null;

        // Función para mostrar la pantalla deseada y ocultar las demás
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
            // Renderizar íconos de Lucide cada vez que se muestra una pantalla
            lucide.createIcons();
        }

        // Función para mostrar mensajes en diferentes partes de la UI
        function showMessage(element, message, classes) {
            element.textContent = message;
            element.className = `${classes} p-4 rounded-md text-center text-sm mt-4`;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 3000);
        }

        // Función para manejar el inicio de sesión
        async function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginMessage = document.getElementById('login-message');

            if (!username || !password) {
                showMessage(loginMessage, 'Por favor, ingrese su usuario y contraseña.', 'bg-yellow-100 text-yellow-700');
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    jwtToken = data.token; 
                    localStorage.setItem('jwtToken', jwtToken);

                    const decodedToken = decodeJwt(jwtToken);
                    console.log(decodedToken);
                    if (decodedToken && decodedToken.rol) {
                        localStorage.setItem('userRole', decodedToken.rol[0].authority);
                    }

                    showScreen('dashboard-screen');
                    updateMenuVisibility(); // New function to update menu visibility
                } else {
                    const errorData = await response.json().catch(() => ({ message: 'Error de autenticación. Verifique sus credenciales.' }));
                    showMessage(loginMessage, errorData.message || 'Error de autenticación.', 'bg-red-100 text-red-700');
                }
            } catch (error) {
                console.error('Error en el login:', error);
                showMessage(loginMessage, 'No se pudo conectar con el servidor. Verifique que el backend esté corriendo.', 'bg-red-100 text-red-700');
            }
        }

        function handleLogout() {
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('userRole');
            jwtToken = null;
            showScreen('login-screen');
        }

        function decodeJwt(token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return null;
            }
        }

        function updateMenuVisibility() {
            const userRole = localStorage.getItem('userRole');
            console.log("User role:", userRole);

            if (userRole === 'TECNICO') {
                document.querySelector('button[onclick="loadUsersAndShowScreen()"]').style.display = 'none';
                document.querySelector('button[onclick="loadPagosAndShowScreen()"]').style.display = 'none';
                document.querySelector('button[onclick="loadClasificacionesAndShowScreen()"]').style.display = 'none';
                document.querySelector('button[onclick="loadPlansAndShowScreen()"]').style.display = 'none';
            } else {
                document.querySelector('button[onclick="loadUsersAndShowScreen()"]').style.display = 'flex';
                document.querySelector('button[onclick="loadPagosAndShowScreen()"]').style.display = 'flex';
                document.querySelector('button[onclick="loadClasificacionesAndShowScreen()"]').style.display = 'flex';
                document.querySelector('button[onclick="loadPlansAndShowScreen()"]').style.display = 'flex';
            }
        }

        // Al cargar la página, verificar si hay un token guardado
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwtToken');
            if (token) {
                jwtToken = token;
                const decodedToken = decodeJwt(jwtToken);
                if (decodedToken) {
                    localStorage.setItem('userRole', decodedToken.rol[0].authority);
                }
                showScreen('dashboard-screen');
                updateMenuVisibility();
            }
            // Inicializa los íconos de Lucide
            lucide.createIcons();
        });

        // --- Lógica para la Gestión de Usuarios ---
        let editingUserId = null;
        let usersCache = []; // Cache for users to avoid re-fetching for edits

        // Función para mostrar mensajes de estado en la UI de gestión de usuarios
        function showStatus(message, type) {
            const statusMessageElement = document.getElementById('status-message');
            statusMessageElement.textContent = message;
            statusMessageElement.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'bg-yellow-100', 'text-yellow-700');
            
            if (type === 'success') {
                statusMessageElement.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                statusMessageElement.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'info') {
                statusMessageElement.classList.add('bg-blue-100', 'text-blue-800');
            } else { // default or warning
                statusMessageElement.classList.add('bg-yellow-100', 'text-yellow-700');
            }
            statusMessageElement.classList.remove('hidden');
            
            setTimeout(() => {
                statusMessageElement.classList.add('hidden');
            }, 3000);
        }

        // Renderiza la lista completa de usuarios.
        function renderUsers() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            if (usersCache.length === 0) {
                usersList.innerHTML = '<p class="text-gray-500 italic p-4 bg-white rounded-lg border border-gray-200 shadow-sm">No hay usuarios registrados.</p>';
                return;
            }

            // Sort users alphabetically by username
            usersCache.sort((a, b) => a.username.localeCompare(b.username)).forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-white border border-slate-200 rounded-lg shadow-md hover:shadow-lg transition-shadow';
                
                let roleColorClass, roleBgClass, roleIcon;
                const roleName = user.rol ? user.rol.nombreRol : 'Sin rol';

                if (roleName === 'ADMINISTRADOR') {
                    roleColorClass = 'text-blue-900';
                    roleBgClass = 'bg-blue-100';
                    roleIcon = 'crown';
                } else if (roleName === 'TECNICO') {
                    roleColorClass = 'text-cyan-800';
                    roleBgClass = 'bg-cyan-100';
                    roleIcon = 'hard-hat';
                } else { // Default for other roles or 'Sin rol'
                    roleColorClass = 'text-slate-700';
                    roleBgClass = 'bg-slate-100';
                    roleIcon = 'eye';
                }

                userCard.innerHTML = `
                    <div class="mb-2 sm:mb-0 min-w-0 flex-grow">
                        <p class="text-lg font-semibold text-gray-800 truncate flex items-center gap-2">
                            <i data-lucide="user-circle" class="w-5 h-5 text-blue-500"></i> ${user.nombre || ''} ${user.apellido || ''} 
                        </p>
                        <p class="text-sm font-normal text-gray-500 flex items-center gap-1 ml-7 mt-0.5">
                            <i data-lucide="at-sign" class="w-3.5 h-3.5 text-slate-400"></i> ${user.username}
                        </p>
                    </div>
                    <div class="flex items-center space-x-3 flex-shrink-0 mt-2 sm:mt-0">
                        <span class="text-xs font-bold uppercase px-2.5 py-1 rounded-full ${roleColorClass} ${roleBgClass} flex items-center gap-1.5 shadow-sm">
                             <i data-lucide="${roleIcon}" class="w-3.5 h-3.5"></i> ${roleName}
                        </span>
                        
                        <button data-id="${user.idUsuario}" class="edit-btn text-blue-500 hover:text-blue-700 transition-colors p-1.5 rounded-md hover:bg-blue-50" title="Editar">
                            <i data-lucide="square-pen" class="w-5 h-5"></i>
                        </button>
                        
                        <button data-id="${user.idUsuario}" class="delete-btn text-red-500 hover:text-red-700 transition-colors p-1.5 rounded-md hover:bg-red-50" title="Eliminar">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                usersList.appendChild(userCard);
            });

            lucide.createIcons(); // Re-execute Lucide after adding new elements to the DOM

            // Re-attach listeners after rendering
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', handleEditUser);
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDeleteUser);
            });
        }

        async function loadUsers() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '<p class="text-center py-4 text-gray-500">Cargando usuarios...</p>';

            if (!jwtToken) {
                showStatus('Tu sesión ha expirado. Por favor, inicia sesión de nuevo.', 'error');
                showScreen('login-screen');
                return;
            }

            try {
                const response = await fetch('/api/usuarios', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (response.status === 403) {
                    showStatus('Tu sesión ha expirado o no tienes permisos. Por favor, inicia sesión de nuevo.', 'error');
                    showScreen('login-screen');
                    return;
                }

                if (!response.ok) throw new Error('Error al cargar los usuarios.');

                const users = await response.json();
                usersCache = users; // Cache the fetched users
                renderUsers();

            } catch (error) {
                console.error('Error en loadUsers:', error);
                showStatus('Error al cargar los datos de usuarios.', 'error');
                usersList.innerHTML = '<p class="text-center py-4 text-red-500">Error al cargar los datos.</p>';
            }
        }

        function handleEditUser(event) {
            const userId = parseInt(event.currentTarget.dataset.id);
            const user = usersCache.find(u => u.idUsuario === userId);

            if (user) {
                editingUserId = user.idUsuario;
                userNameInput.value = user.nombre || '';
                userLastnameInput.value = user.apellido || '';
                userUsernameInput.value = user.username;
                userRoleSelect.value = user.rol ? user.rol.nombreRol : '';
                
                userPasswordInput.value = ''; 
                userPasswordInput.placeholder = 'Dejar vacío para no cambiar';

                saveButtonText.textContent = 'Actualizar Usuario';
                saveButton.innerHTML = `<i data-lucide="save" class="w-5 h-5"></i> <span id="save-button-text">Actualizar Usuario</span>`;
                lucide.createIcons();
                cancelButton.classList.remove('hidden');
                
                userNameInput.focus();
                
                showStatus(`Modo Edición: Editando a ${user.nombre || ''} ${user.apellido || ''}.`, 'info');
            }
        }

        async function handleDeleteUser(event) {
            const userId = parseInt(event.currentTarget.dataset.id);
            if (!confirm(`¿Estás seguro de que quieres eliminar al usuario con ID ${userId}?`)) return;

            try {
                const response = await fetch(`/api/usuarios/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (response.ok) {
                    showStatus('¡Usuario eliminado con éxito!', 'success');
                    await loadUsers();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showStatus(errorData.message || 'Error al eliminar el usuario.', 'error');
                }
            } catch (error) {
                console.error('Error en handleDeleteUser:', error);
                showStatus('No se pudo conectar con el servidor.', 'error');
            }
        }

        function cancelEdit() {
            editingUserId = null;
            document.getElementById('user-form').reset();
            userPasswordInput.placeholder = 'Mínimo 8 caracteres';
            saveButtonText.textContent = 'Guardar Usuario';
            saveButton.innerHTML = `<i data-lucide="save" class="w-5 h-5"></i> <span id="save-button-text">Guardar Usuario</span>`;
            lucide.createIcons();
            cancelButton.classList.add('hidden');
        }

        async function handleSaveUser() {
            initializeUserFormElements();
            const username = userUsernameInput.value.trim();
            const password = userPasswordInput.value;
            const role = userRoleSelect.value;
            const nombre = userNameInput.value.trim();
            const apellido = userLastnameInput.value.trim();

            if (!username || !role) {
                showStatus('El nombre de usuario y el rol son requeridos.', 'warning');
                return;
            }

            if (!editingUserId && !password) {
                showStatus('La contraseña es requerida para nuevos usuarios.', 'warning');
                return;
            }
            
            if (password && password.length < 8) {
                showStatus('La contraseña debe tener al menos 8 caracteres.', 'warning');
                return;
            }

            let url;
            let method;
            let body;

            if (editingUserId) {
                url = `/api/usuarios/${editingUserId}`;
                method = 'PUT';
                        body = {
                            nombre: nombre,
                            apellido: apellido,
                            username: username,
                            ...(password && { password: password }),
                            role: role
                        };            } else {
                url = '/api/auth/register';
                method = 'POST';
                body = {
                    nombre: nombre,
                    apellido: apellido,
                    username: username,
                    password: password,
                    role: role
                };
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    const result = await response.json();
                    const successMessage = editingUserId ? '¡Usuario actualizado con éxito!' : '¡Usuario creado con éxito!';
                    showStatus(successMessage, 'success');
                    cancelEdit();
                    await loadUsers();
                } else {
                    const errorData = await response.json().catch(() => ({ message: 'Error al guardar el usuario.' }));
                    showStatus(errorData.message || 'Error al guardar el usuario.', 'error');
                }
            } catch (error) {
                console.error('Error en handleSaveUser:', error);
                showStatus('No se pudo conectar con el servidor.', 'error');
            }
        }

        function loadUsersAndShowScreen() {
            loadUsers();
            showScreen('users-screen');
        }

        // --- Lógica para Crear y Editar Usuarios ---
        // Declare these variables globally but assign them inside a function
        // that runs when the screen is active to ensure elements are in DOM.
        let userNameInput;
        let userLastnameInput;
        let userUsernameInput;
        let userPasswordInput;
        let userRoleSelect;
        let saveButton;
        let saveButtonText;
        let cancelButton;

        function initializeUserFormElements() {
            userNameInput = document.getElementById('user-name');
            userLastnameInput = document.getElementById('user-lastname');
            userUsernameInput = document.getElementById('user-username');
            userPasswordInput = document.getElementById('user-password');
            userRoleSelect = document.getElementById('user-role');
            saveButton = document.getElementById('save-button');
            saveButtonText = document.getElementById('save-button-text');
            cancelButton = document.getElementById('cancel-edit-button');
        }



        // --- Lógica para Gestión de Clientes ---
        let editingClienteId = null;

        function loadClientesAndShowScreen() {
            loadClientes();
            showScreen('clients-screen');
        }

        function handleSearchClientes() {
            const query = document.getElementById('cliente-search-query').value;
            loadClientes(query);
        }

        function startEditCliente(cliente) {
            editingClienteId = cliente.idCliente;
            document.getElementById('cliente-form-nombre').value = cliente.nombre;
            document.getElementById('cliente-form-apellido').value = cliente.apellido;
            document.getElementById('cliente-form-telefono').value = cliente.telefono;
            document.getElementById('cliente-form-direccion').value = cliente.direccion;
            document.getElementById('cliente-form-dpi').value = cliente.dpi;
            document.getElementById('cliente-form-estado').value = cliente.estadoCliente;
            document.getElementById('cliente-form-button').textContent = 'Actualizar Cliente';
            document.getElementById('cancel-edit-cliente-button').classList.remove('hidden');
        }

        function cancelEditCliente() {
            editingClienteId = null;
            document.getElementById('cliente-form').reset();
            document.getElementById('cliente-form-button').textContent = 'Guardar Cliente';
            document.getElementById('cancel-edit-cliente-button').classList.add('hidden');
        }

        async function handleSaveCliente() {
            const formMessage = document.getElementById('cliente-form-message');
            const body = {
                nombre: document.getElementById('cliente-form-nombre').value,
                apellido: document.getElementById('cliente-form-apellido').value,
                telefono: document.getElementById('cliente-form-telefono').value,
                direccion: document.getElementById('cliente-form-direccion').value,
                dpi: document.getElementById('cliente-form-dpi').value,
                estadoCliente: document.getElementById('cliente-form-estado').value
            };

            if (!body.nombre || !body.apellido || !body.dpi || !body.telefono) {
                showMessage(formMessage, 'Nombre, Apellido, Teléfono y DPI son requeridos.', 'bg-yellow-100 text-yellow-700');
                return;
            }

            const url = editingClienteId ? `/api/clientes/${editingClienteId}` : '/api/clientes';
            const method = editingClienteId ? 'PUT' : 'POST';
            if (editingClienteId) body.idCliente = editingClienteId;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
                    body: JSON.stringify(body)
                });
                const result = await response.json();

                if (result.success) {
                    showMessage(formMessage, result.message, 'bg-green-100 text-green-700');
                    cancelEditCliente();
                    await loadClientes();
                } else {
                    showMessage(formMessage, result.message || 'Error al guardar el cliente.', 'bg-red-100 text-red-700');
                }
            } catch (error) {
                showMessage(formMessage, 'Error de conexión.', 'bg-red-100 text-red-700');
            }
        }

        async function handleDeleteCliente(clienteId) {
            if (!confirm(`¿Seguro que quieres inactivar al cliente con ID ${clienteId}?`)) return;

            const formMessage = document.getElementById('cliente-form-message');
            try {
                const response = await fetch(`/api/clientes/${clienteId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });
                const result = await response.json();

                if (result.success) {
                    showMessage(formMessage, result.message, 'bg-green-100 text-green-700');
                    await loadClientes();
                } else {
                    showMessage(formMessage, result.message || 'Error al eliminar.', 'bg-red-100 text-red-700');
                }
            } catch (error) {
                showMessage(formMessage, 'Error de conexión.', 'bg-red-100 text-red-700');
            }
        }

        async function loadClientes(query = '') {
            const listBody = document.getElementById('cliente-list-body');
            listBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Cargando...</td></tr>';
            
            const url = query ? `/api/clientes/buscar?query=${encodeURIComponent(query)}` : '/api/clientes';

            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${jwtToken}` } });
                const result = await response.json();

                if (!result.success) throw new Error(result.message || 'Error de red.');
                
                const data = result.data;
                listBody.innerHTML = '';
                if (data.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No se encontraron clientes.</td></tr>';
                    return;
                }

                data.forEach(item => {
                    const itemDataString = JSON.stringify(item).replace(/'/g, "'");
                    const estadoClass = item.estadoCliente === 'ACTIVO' ? 'text-green-600' : 'text-red-600';
                    listBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4">${item.idCliente}</td>
                            <td class="px-6 py-4">${item.nombre} ${item.apellido}</td>
                            <td class="px-6 py-4">${item.telefono}</td>
                            <td class="px-6 py-4">${item.direccion}</td>
                            <td class="px-6 py-4">${item.dpi}</td>
                            <td class="px-6 py-4 font-bold ${estadoClass}">${item.estadoCliente}</td>
                            <td class="px-6 py-4">
                                <button onclick='startEditCliente(${itemDataString})' class="text-indigo-600 hover:text-indigo-900">Editar</button>
                                <button onclick="handleDeleteCliente(${item.idCliente})" class="text-red-600 hover:text-red-900 ml-2">Inactivar</button>
                            </td>
                        </tr>`;
                });
            } catch (error) {
                listBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">${error.message || "Error al cargar datos."}</td></tr>`;
            }
        }

        // --- Lógica para la Gestión de Planes ---
        let editingPlanId = null;

        function loadPlansAndShowScreen() {
            loadPlans();
            showScreen('plans-screen');
        }

        function startEditPlan(plan) {
            editingPlanId = plan.idPlan;
            document.getElementById('plan-form-nombre').value = plan.nombrePlan;
            document.getElementById('plan-form-velocidad').value = plan.velocidad;
            document.getElementById('plan-form-costo').value = plan.costoMensual;
            document.getElementById('plan-form-button').textContent = 'Actualizar Plan';
            document.getElementById('cancel-edit-plan-button').classList.remove('hidden');
        }

        function cancelEditPlan() {
            editingPlanId = null;
            document.getElementById('plan-form').reset();
            document.getElementById('plan-form-button').textContent = 'Guardar Plan';
            document.getElementById('cancel-edit-plan-button').classList.add('hidden');
        }

        async function handleSavePlan() {
            const nombrePlan = document.getElementById('plan-form-nombre').value;
            const velocidad = document.getElementById('plan-form-velocidad').value;
            const costoMensual = document.getElementById('plan-form-costo').value;
            const formMessage = document.getElementById('plan-form-message');

            if (!nombrePlan || !velocidad || !costoMensual) {
                showMessage(formMessage, 'Todos los campos son requeridos.', 'bg-yellow-100 text-yellow-700');
                return;
            }

            const url = editingPlanId ? `/api/planes/${editingPlanId}` : '/api/planes';
            const method = editingPlanId ? 'PUT' : 'POST';

            const body = { nombrePlan, velocidad, costoMensual };
            if (editingPlanId) body.idPlan = editingPlanId;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    const successMessage = editingPlanId ? '¡Plan actualizado!' : '¡Plan creado!';
                    showMessage(formMessage, successMessage, 'bg-green-100 text-green-700');
                    cancelEditPlan();
                    await loadPlans();
                } else {
                    const errorData = await response.json();
                    showMessage(formMessage, errorData.message || 'Error al guardar el plan.', 'bg-red-100 text-red-700');
                }
            } catch (error) {
                console.error('Error en handleSavePlan:', error);
                showMessage(formMessage, 'No se pudo conectar con el servidor.', 'bg-red-100 text-red-700');
            }
        }

        async function handleDeletePlan(planId) {
            if (!confirm(`¿Estás seguro de eliminar el plan con ID ${planId}?`)) return;

            try {
                const response = await fetch(`/api/planes/${planId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (response.ok) {
                    showMessage(document.getElementById('plan-form-message'), '¡Plan eliminado!', 'bg-green-100 text-green-700');
                    await loadPlans();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showMessage(document.getElementById('plan-form-message'), errorData.message || 'Error al eliminar el plan.', 'bg-red-100 text-red-700');
                }
            } catch (error) {
                console.error('Error en handleDeletePlan:', error);
                showMessage(document.getElementById('plan-form-message'), 'No se pudo conectar con el servidor.', 'bg-red-100 text-red-700');
            }
        }

        async function loadPlans() {
            const planListBody = document.getElementById('plan-list-body');
            planListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Cargando...</td></tr>';

            try {
                const response = await fetch('/api/planes', { headers: { 'Authorization': `Bearer ${jwtToken}` } });
                if (!response.ok) throw new Error('Error al cargar los planes.');

                const planes = await response.json();
                planListBody.innerHTML = '';

                if (planes.length === 0) {
                    planListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No se encontraron planes.</td></tr>';
                    return;
                }

                planes.forEach(plan => {
                    const planDataString = JSON.stringify(plan).replace(/'/g, "'");
                    const row = `
                        <tr>
                            <td class="px-6 py-4">${plan.idPlan}</td>
                            <td class="px-6 py-4">${plan.nombrePlan}</td>
                            <td class="px-6 py-4">${plan.velocidad}</td>
                            <td class="px-6 py-4">Q${plan.costoMensual.toFixed(2)}</td>
                            <td class="px-6 py-4">
                                <button onclick='startEditPlan(${planDataString})' class="text-indigo-600 hover:text-indigo-900">Editar</button>
                                <button onclick="handleDeletePlan(${plan.idPlan})" class="text-red-600 hover:text-red-900 ml-2">Eliminar</button>
                            </td>
                        </tr>
                    `;
                    planListBody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error en loadPlans:', error);
            }
        }

        // --- Lógica para Clasificación de Dispositivos ---
        let editingClasificacionId = null;

        function loadClasificacionesAndShowScreen() {
            loadClasificaciones();
            showScreen('device-class-screen');
        }

        function startEditClasificacion(clasificacion) {
            editingClasificacionId = clasificacion.idClasificacion;
            document.getElementById('clasificacion-form-nombre').value = clasificacion.nombreClasificacion;
            document.getElementById('clasificacion-form-button').textContent = 'Actualizar';
            document.getElementById('cancel-edit-clasificacion-button').classList.remove('hidden');
        }

        function cancelEditClasificacion() {
            editingClasificacionId = null;
            document.getElementById('clasificacion-form').reset();
            document.getElementById('clasificacion-form-button').textContent = 'Guardar';
            document.getElementById('cancel-edit-clasificacion-button').classList.add('hidden');
        }

        async function handleSaveClasificacion() {
            const nombre = document.getElementById('clasificacion-form-nombre').value;
            const formMessage = document.getElementById('clasificacion-form-message');
            if (!nombre) {
                showMessage(formMessage, 'El nombre es requerido.', 'bg-yellow-100 text-yellow-700');
                return;
            }

            const url = editingClasificacionId ? `/api/clasificaciones/${editingClasificacionId}` : '/api/clasificaciones';
            const method = editingClasificacionId ? 'PUT' : 'POST';
            const body = { nombreClasificacion: nombre };
            if (editingClasificacionId) body.idClasificacion = editingClasificacionId;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
                    body: JSON.stringify(body)
                });
                if (response.ok) {
                    showMessage(formMessage, `¡Clasificación ${editingClasificacionId ? 'actualizada' : 'creada'}!`, 'bg-green-100 text-green-700');
                    cancelEditClasificacion();
                    await loadClasificaciones();
                } else {
                    const error = await response.json();
                    showMessage(formMessage, error.message || 'Error al guardar.', 'bg-red-100 text-red-700');
                }
            } catch (error) {
                showMessage(formMessage, 'Error de conexión.', 'bg-red-100 text-red-700');
            }
        }

        async function handleDeleteClasificacion(id) {
            if (!confirm(`¿Seguro que quieres eliminar la clasificación con ID ${id}?`)) return;

            try {
                const response = await fetch(`/api/clasificaciones/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });
                if (response.ok) {
                    showMessage(document.getElementById('clasificacion-form-message'), '¡Eliminada con éxito!', 'bg-green-100 text-green-700');
                    await loadClasificaciones();
                } else {
                    const error = await response.json().catch(() => ({}));
                    showMessage(document.getElementById('clasificacion-form-message'), error.message || 'Error al eliminar.', 'bg-red-100 text-red-700');
                }
            } catch (error) {
                showMessage(document.getElementById('clasificacion-form-message'), 'Error de conexión.', 'bg-red-100 text-red-700');
            }
        }

        async function loadClasificaciones() {
            const listBody = document.getElementById('clasificacion-list-body');
            listBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">Cargando...</td></tr>';
            try {
                const response = await fetch('/api/clasificaciones', { headers: { 'Authorization': `Bearer ${jwtToken}` } });
                if (!response.ok) throw new Error('Error de red.');
                const data = await response.json();
                listBody.innerHTML = '';
                if (data.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">No hay clasificaciones.</td></tr>';
                    return;
                }
                data.forEach(item => {
                    const itemDataString = JSON.stringify(item).replace(/'/g, "'");
                    listBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4">${item.idClasificacion}</td>
                            <td class="px-6 py-4">${item.nombreClasificacion}</td>
                            <td class="px-6 py-4">
                                <button onclick='startEditClasificacion(${itemDataString})' class="text-indigo-600 hover:text-indigo-900">Editar</button>
                                <button onclick="handleDeleteClasificacion(${item.idClasificacion})" class="text-red-600 hover:text-red-900 ml-2">Eliminar</button>
                            </td>
                        </tr>`;
                });
            } catch (error) {
                listBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500">Error al cargar datos.</td></tr>';
            }
        }

        // --- Lógica para Gestión de Dispositivos ---
        let editingDispositivoId = null;
        let clasificacionesCache = [];

        async function loadDispositivosAndShowScreen() {
            await loadDispositivos();
            await loadClasificacionesIntoSelect();
            showScreen('devices-screen');
        }

        function handleSearchDispositivos() {
            const query = document.getElementById('dispositivo-search-query').value;
            loadDispositivos(query);
        }

        async function loadClasificacionesIntoSelect() {
            const select = document.getElementById('dispositivo-form-clasificacion');
            if (clasificacionesCache.length === 0) {
                try {
                    const response = await fetch('/api/clasificaciones', { headers: { 'Authorization': `Bearer ${jwtToken}` } });
                    if (!response.ok) throw new Error('Error de red.');
                    clasificacionesCache = await response.json();
                } catch (error) {
                    console.error("Error cargando clasificaciones:", error);
                    select.innerHTML = '<option>Error al cargar</option>';
                    return;
                }
            }
            select.innerHTML = clasificacionesCache.map(c => `<option value="${c.idClasificacion}">${c.nombreClasificacion}</option>`).join('');
        }

        function startEditDispositivo(dispositivo) {
            editingDispositivoId = dispositivo.idDispositivo;
            document.getElementById('dispositivo-form-modelo').value = dispositivo.modelo;
            document.getElementById('dispositivo-form-mac').value = dispositivo.direccionMac;
            document.getElementById('dispositivo-form-ip').value = dispositivo.ipLocal;
            document.getElementById('dispositivo-form-wifi').value = dispositivo.contrasenaWifi;
            document.getElementById('dispositivo-form-ssid').value = dispositivo.ssid;
            document.getElementById('dispositivo-form-clasificacion').value = dispositivo.idClasificacion;
            document.getElementById('dispositivo-form-button').textContent = 'Actualizar Dispositivo';
            document.getElementById('cancel-edit-dispositivo-button').classList.remove('hidden');
        }

        function cancelEditDispositivo() {
            editingDispositivoId = null;
            document.getElementById('dispositivo-form').reset();
            document.getElementById('dispositivo-form-button').textContent = 'Guardar Dispositivo';
            document.getElementById('cancel-edit-dispositivo-button').classList.add('hidden');
        }

        async function handleSaveDispositivo() {
            const formMessage = document.getElementById('dispositivo-form-message');
            const idClasificacion = parseInt(document.getElementById('dispositivo-form-clasificacion').value, 10);

            const body = {
                modelo: document.getElementById('dispositivo-form-modelo').value,
                direccionMac: document.getElementById('dispositivo-form-mac').value,
                ipLocal: document.getElementById('dispositivo-form-ip').value,
                contrasenaWifi: document.getElementById('dispositivo-form-wifi').value,
                ssid: document.getElementById('dispositivo-form-ssid').value,
                idClasificacion: idClasificacion
            };

            if (!body.modelo || !body.direccionMac || isNaN(body.idClasificacion)) {
                showMessage(formMessage, 'Modelo, MAC y Clasificación son requeridos y deben ser válidos.', 'bg-yellow-100 text-yellow-700');
                return;
            }

            const url = editingDispositivoId ? `/api/dispositivos/${editingDispositivoId}` : '/api/dispositivos';
            const method = editingDispositivoId ? 'PUT' : 'POST';
            if (editingDispositivoId) body.idDispositivo = editingDispositivoId;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
                    body: JSON.stringify(body)
                });
                if (response.ok) {
                    showMessage(formMessage, `¡Dispositivo ${editingDispositivoId ? 'actualizado' : 'creado'}!`, 'bg-green-100 text-green-700');
                    cancelEditDispositivo();
                    await loadDispositivos();
                } else {
                    const error = await response.json();
                    showMessage(formMessage, error.message || 'Error al guardar.', 'bg-red-100 text-red-700');
                }
            } catch (error) {
                showMessage(formMessage, 'Error de conexión.', 'bg-red-100 text-red-700');
            }
        }

        async function handleDeleteDispositivo(id) {
            if (!confirm(`¿Seguro que quieres eliminar el dispositivo con ID ${id}?`)) return;
            const formMessage = document.getElementById('dispositivo-form-message');
            try {
                const response = await fetch(`/api/dispositivos/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });
                if (response.ok) {
                    showMessage(formMessage, '¡Dispositivo eliminado!', 'bg-green-100 text-green-700');
                    await loadDispositivos();
                } else {
                    const error = await response.json().catch(() => ({}));
                    showMessage(formMessage, error.message || 'Error al eliminar.', 'bg-red-100 text-red-700');
                }
            } catch (error) {
                showMessage(formMessage, 'Error de conexión.', 'bg-red-100 text-red-700');
            }
        }

        async function loadDispositivos(query = '') {
            const listBody = document.getElementById('dispositivo-list-body');
            listBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Cargando...</td></tr>';
            
            const url = query ? `/api/dispositivos/buscar?query=${encodeURIComponent(query)}` : '/api/dispositivos';

            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${jwtToken}` } });
                if (!response.ok) throw new Error('Error de red.');
                const data = await response.json();
                listBody.innerHTML = '';
                if (data.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No hay dispositivos.</td></tr>';
                    return;
                }
                if (clasificacionesCache.length === 0) await loadClasificacionesIntoSelect();

                data.forEach(item => {
                    const clasificacion = clasificacionesCache.find(c => c.idClasificacion === item.idClasificacion);
                    const clasificacionNombre = clasificacion ? clasificacion.nombreClasificacion : 'N/A';
                    const itemDataString = JSON.stringify(item).replace(/'/g, "'");
                    listBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4">${item.idDispositivo}</td>
                            <td class="px-6 py-4">${item.modelo}</td>
                            <td class="px-6 py-4">${item.direccionMac}</td>
                            <td class="px-6 py-4">${clasificacionNombre}</td>
                            <td class="px-6 py-4">
                                <button onclick='startEditDispositivo(${itemDataString})' class="text-indigo-600 hover:text-indigo-900">Editar</button>
                                <button onclick="handleDeleteDispositivo(${item.idDispositivo})" class="text-red-600 hover:text-red-900 ml-2">Eliminar</button>
                            </td>
                        </tr>`;
                });
            } catch (error) {
                listBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Error al cargar datos.</td></tr>';
            }
        }

        // --- Lógica para Gestión de Servicios ---
        let editingServicioId = null;
        let clientesCache = [], planesCache = [], dispositivosCache = [];

        async function loadServiciosAndShowScreen() {
            cancelEditServicio();
            await loadPrerequisitesForServicioForm();
            await loadServicios();
            showScreen('services-screen');
        }

        function handleSearchServicios() {
            const query = document.getElementById('servicio-search-query').value;
            loadServicios(query);
        }        

        async function loadPrerequisitesForServicioForm() {
            const [clientesRes, planesRes, dispositivosRes, clasificacionesRes] = await Promise.all([
                fetch('/api/clientes', { headers: { 'Authorization': `Bearer ${jwtToken}` } }),
                fetch('/api/planes', { headers: { 'Authorization': `Bearer ${jwtToken}` } }),
                fetch('/api/dispositivos', { headers: { 'Authorization': `Bearer ${jwtToken}` } }),
                fetch('/api/clasificaciones', { headers: { 'Authorization': `Bearer ${jwtToken}` } })
            ]);

            if (clientesRes.ok) {
                const clientesResult = await clientesRes.json();
                clientesCache = clientesResult.data;
                const clienteSelect = document.getElementById('servicio-form-cliente');
                clienteSelect.innerHTML = '<option value="" disabled selected>-- Seleccione Cliente --</option>' +
                                          clientesCache.map(c => `<option value="${c.idCliente}">${c.nombre} ${c.apellido}</option>`).join('');
            }
            if (planesRes.ok) {
                planesCache = await planesRes.json();
                const planSelect = document.getElementById('servicio-form-plan');
                planSelect.innerHTML = '<option value="" disabled selected>-- Seleccione Plan --</option>' +
                                       planesCache.map(p => `<option value="${p.idPlan}">${p.nombrePlan}</option>`).join('');
            }
            if (dispositivosRes.ok) {
                dispositivosCache = await dispositivosRes.json();
                const dispositivoSelect = document.getElementById('servicio-form-dispositivo');
                dispositivoSelect.innerHTML = '<option value="" disabled selected>-- Seleccione Dispositivo --</option>' +
                                              dispositivosCache.map(d => `<option value="${d.idDispositivo}">${d.modelo} (${d.direccionMac})</option>`).join('');
            }
            if (clasificacionesRes.ok) {
                clasificacionesCache = await clasificacionesRes.json();
            }
        }

        function startEditServicio(servicio) {
            editingServicioId = servicio.idServicio;
            document.getElementById('servicio-form-cliente').value = servicio.idCliente;
            document.getElementById('servicio-form-plan').value = servicio.plan.idPlan;
            document.getElementById('servicio-form-dispositivo').value = servicio.dispositivo.idDispositivo;
            document.getElementById('servicio-form-fecha-activacion').value = new Date(servicio.fechaActivacion).toISOString().split('T')[0];
            document.getElementById('servicio-form-proximo-pago').value = new Date(servicio.proximoPago).toISOString().split('T')[0];
            document.getElementById('servicio-form-estado').value = servicio.estadoServicio;
            document.getElementById('servicio-form-descuento').value = servicio.descuentoMonto;
            document.getElementById('servicio-form-button').textContent = 'Actualizar Servicio';
            document.getElementById('cancel-edit-servicio-button').classList.remove('hidden');
        }

        function cancelEditServicio() {
            editingServicioId = null;
            document.getElementById('servicio-form').reset();
            document.getElementById('servicio-form-button').textContent = 'Guardar Servicio';
            document.getElementById('cancel-edit-servicio-button').classList.add('hidden');
        }

        async function handleSaveServicio() {
            const formMessage = document.getElementById('servicio-form-message');
            const body = {
                idCliente: parseInt(document.getElementById('servicio-form-cliente').value, 10),
                idPlan: parseInt(document.getElementById('servicio-form-plan').value, 10),
                idDispositivo: parseInt(document.getElementById('servicio-form-dispositivo').value, 10),
                fechaActivacion: document.getElementById('servicio-form-fecha-activacion').value,
                proximoPago: document.getElementById('servicio-form-proximo-pago').value,
                estadoServicio: document.getElementById('servicio-form-estado').value,
                descuentoMonto: parseFloat(document.getElementById('servicio-form-descuento').value)
            };

            if (isNaN(body.idCliente) || isNaN(body.idPlan) || isNaN(body.idDispositivo)) {
                showMessage(formMessage, 'Cliente, Plan y Dispositivo son requeridos.', 'bg-yellow-100 text-yellow-700');
                return;
            }

            const url = editingServicioId ? `/api/servicios/${editingServicioId}` : '/api/servicios';
            const method = editingServicioId ? 'PUT' : 'POST';
            if (editingServicioId) body.idServicio = editingServicioId;

            try {
                const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` }, body: JSON.stringify(body) });
                const result = await response.json();
                if (result.success) {
                    showMessage(formMessage, result.message, 'bg-green-100 text-green-700');
                    cancelEditServicio();
                    await loadServicios();
                } else {
                    showMessage(formMessage, result.message || 'Error al guardar.', 'bg-red-100 text-red-700');
                }
            } catch (error) {
                showMessage(formMessage, 'Error de conexión.', 'bg-red-100 text-red-700');
            }
        }

        async function handleDeleteServicio(id) {
            if (!confirm(`¿Seguro que quieres eliminar el servicio con ID ${id}?`)) return;
            const formMessage = document.getElementById('servicio-form-message');
            try {
                const response = await fetch(`/api/servicios/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${jwtToken}` } });
                const result = await response.json();
                if (result.success) {
                    showMessage(formMessage, '¡Servicio eliminado!', 'bg-green-100 text-green-700');
                    await loadServicios();
                } else {
                    showMessage(formMessage, result.message || 'Error al eliminar.', 'bg-red-100 text-red-700');
                }
            } catch (error) {
                showMessage(formMessage, 'Error de conexión.', 'bg-red-100 text-red-700');
            }
        }

        async function loadServicios(query = '') {
            const listBody = document.getElementById('servicio-list-body');
            listBody.innerHTML = '<tr><td colspan="10" class="text-center py-4">Cargando...</td></tr>';
            
            const url = query ? `/api/servicios/buscar?query=${encodeURIComponent(query)}` : '/api/servicios';

            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${jwtToken}` } });
                const result = await response.json();
                if (!result.success) throw new Error(result.message || 'Error de red.');
                const data = result.data;
                listBody.innerHTML = '';
                if (data.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="10" class="text-center py-4">No hay servicios.</td></tr>';
                    return;
                }

                data.forEach(item => {
                    const cliente = clientesCache.find(c => c.idCliente === item.idCliente);
                    const clienteNombre = cliente ? `${cliente.nombre} ${cliente.apellido}` : 'N/A';
                    const planNombre = item.plan ? item.plan.nombrePlan : 'N/A';
                    const dispositivoNombre = item.dispositivo ? item.dispositivo.modelo : 'N/A';
                    const dispositivoMac = item.dispositivo ? item.dispositivo.direccionMac : 'N/A';
                    const clasificacion = item.dispositivo && clasificacionesCache.find(c => c.idClasificacion === item.dispositivo.idClasificacion);
                    const clasificacionNombre = clasificacion ? clasificacion.nombreClasificacion : 'N/A';
                    const proximoPagoFormateado = new Date(item.proximoPago).toLocaleDateString();
                    const descuentoFormateado = `Q${item.descuentoMonto.toFixed(2)}`;
                    const estadoClass = item.estadoServicio === 'ACTIVO' ? 'text-green-600' : 'text-red-600';
                    const itemDataString = JSON.stringify(item).replace(/'/g, "'");

                    listBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4">${item.idServicio}</td>
                            <td class="px-6 py-4">${clienteNombre}</td>
                            <td class="px-6 py-4">${planNombre}</td>
                            <td class="px-6 py-4">${dispositivoNombre}</td>
                            <td class="px-6 py-4">${dispositivoMac}</td>
                            <td class="px-6 py-4">${clasificacionNombre}</td>
                            <td class="px-6 py-4">${proximoPagoFormateado}</td>
                            <td class="px-6 py-4">${descuentoFormateado}</td>
                            <td class="px-6 py-4 font-bold ${estadoClass}">${item.estadoServicio}</td>
                            <td class="px-6 py-4">
                                <button onclick='startEditServicio(${itemDataString})' class="text-indigo-600 hover:text-indigo-900">Editar</button>
                                <button onclick="handleDeleteServicio(${item.idServicio})" class="text-red-600 hover:text-red-900 ml-2">Eliminar</button>
                            </td>
                        </tr>`;
                });
            } catch (error) {
                listBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-red-500">${error.message || "Error al cargar datos."}</td></tr>`;
            }
        }



        // --- Lógica para Registro de Pagos ---
        let serviciosActivosCache = [];

        async function loadPagosAndShowScreen() {
            await loadPrerequisitesForPagoForm();
            await loadPagos();
            showScreen('payments-screen');
        }

        function handleSearchPagos() {
            const query = document.getElementById('pago-search-query').value;
            loadPagos(query);
        }

        async function loadPrerequisitesForPagoForm() {
            const select = document.getElementById('cliente_servicio');
            try {
                const response = await fetch('/api/servicios', { headers: { 'Authorization': `Bearer ${jwtToken}` } });
                const result = await response.json();
                if (!result.success) throw new Error('No se pudieron cargar los servicios.');
                
                if (clientesCache.length === 0) {
                    const clientesRes = await fetch('/api/clientes', { headers: { 'Authorization': `Bearer ${jwtToken}` } });
                    const clientesResult = await clientesRes.json();
                    if(clientesResult.success) clientesCache = clientesResult.data;
                }

                serviciosActivosCache = result.data;
                select.innerHTML = '<option value="" disabled selected>-- Seleccione un servicio --</option>';
                serviciosActivosCache.forEach(servicio => {
                    const cliente = clientesCache.find(c => c.idCliente === servicio.idCliente);
                    const clienteNombre = cliente ? `${cliente.nombre} ${cliente.apellido}` : 'Cliente Desconocido';
                    const planNombre = servicio.plan ? servicio.plan.nombrePlan : 'Plan Desconocido';
                    select.innerHTML += `<option value="${servicio.idServicio}">${clienteNombre} - ${planNombre}</option>`;
                });
            } catch (error) {
                select.innerHTML = '<option>Error al cargar servicios</option>';
            }
        }

        function actualizarInterfazPago() {
            const tipoPago = document.getElementById('tipo_pago').value;
            const diasContainer = document.getElementById('dias-container');
            if (tipoPago === 'dias') {
                diasContainer.classList.remove('hidden');
            } else {
                diasContainer.classList.add('hidden');
                document.getElementById('dias_pagar').value = '';
            }
            actualizarMontoPago();
        }

        function actualizarMontoPago() {
            const idServicio = document.getElementById('cliente_servicio').value;
            const montoPagarInput = document.getElementById('monto_pagar');
            if (!idServicio) {
                montoPagarInput.value = '';
                return;
            }

            const servicio = serviciosActivosCache.find(s => s.idServicio == idServicio);
            if (!servicio || !servicio.plan) return;

            const costoMensual = servicio.plan.costoMensual;
            const tipo = document.getElementById('tipo_pago').value;
            let montoTotal = 0;

            if (tipo === 'mes') {
                montoTotal = costoMensual - (servicio.descuentoMonto || 0);
            } else {
                const dias = parseInt(document.getElementById('dias_pagar').value, 10);
                if (isNaN(dias) || dias <= 0) {
                    montoPagarInput.value = '';
                    return;
                }
                const costoPorDia = costoMensual / 30;
                montoTotal = costoPorDia * dias;
            }
            montoPagarInput.value = `Q${montoTotal.toFixed(2)}`;
        }

        async function handleRegisterPago() {
            const formMessage = document.getElementById('messageBox');
            const idServicio = parseInt(document.getElementById('cliente_servicio').value, 10);
            const montoString = document.getElementById('monto_pagar').value;

            if (isNaN(idServicio) || !montoString) {
                showMessage(formMessage, "Por favor, complete todos los campos requeridos.", 'bg-red-100 text-red-700');
                return;
            }

            const monto = parseFloat(montoString.replace('Q', ''));
            const dias = parseInt(document.getElementById('dias_pagar').value, 10) || 30;
            const fechaHoy = new Date();
            const periodoFin = new Date(fechaHoy.getTime() + (dias * 24 * 60 * 60 * 1000));

            const body = {
                idServicio: idServicio,
                monto: monto,
                metodoPago: 'EFECTIVO',
                diasCubiertos: dias,
                comentario: document.getElementById('comentario').value,
                periodoInicio: fechaHoy.toISOString().split('T')[0],
                periodoFin: periodoFin.toISOString().split('T')[0]
            };

            try {
                const response = await fetch('/api/pagos', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` }, body: JSON.stringify(body) });
                const result = await response.json();
                if (result.success) {
                    showMessage(formMessage, result.message, 'bg-green-100 text-green-700');
                    document.getElementById('cliente_servicio').value = '';
                    document.getElementById('monto_pagar').value = '';
                    document.getElementById('comentario').value = '';
                    await loadPagos();
                } else {
                    showMessage(formMessage, result.message || 'Error al registrar el pago.', 'bg-red-100 text-red-700');
                }
            } catch (error) {
                showMessage(formMessage, 'Error de conexión.', 'bg-red-100 text-red-700');
            }
        }

        async function loadPagos(query = '') {
            const listBody = document.getElementById('pago-history-body');
            listBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Cargando...</td></tr>';

            const url = query ? `/api/pagos/query?query=${encodeURIComponent(query)}` : '/api/pagos';

            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${jwtToken}` } });
                const result = await response.json();
                if (!result.success) throw new Error(result.message || 'Error de red.');
                const data = result.data;
                listBody.innerHTML = '';
                if (data.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No hay pagos registrados.</td></tr>';
                    return;
                }
                if (clientesCache.length === 0) await loadPrerequisitesForPagoForm();

                data.forEach(item => {
                    const servicio = serviciosActivosCache.find(s => s.idServicio === item.idServicio);
                    const cliente = servicio ? clientesCache.find(c => c.idCliente === servicio.idCliente) : null;
                    const clienteNombre = cliente ? `${cliente.nombre} ${cliente.apellido}` : 'N/A';
                    const estadoClass = item.estadoPago === 'REALIZADO' ? 'text-green-600' : 'text-red-600';

                    listBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4">${item.idPago}</td>
                            <td class="px-6 py-4">${new Date(item.fechaPago).toLocaleDateString()}</td>
                            <td class="px-6 py-4">Q${item.monto.toFixed(2)}</td>
                            <td class="px-6 py-4">${clienteNombre}</td>
                            <td class="px-6 py-4">${item.comentario || ''}</td>
                            <td class="px-6 py-4 font-bold ${estadoClass}">${item.estadoPago}</td>
                            <td class="px-6 py-4">
                                <button onclick="handleEditPagoComentario(${item.idPago}, '${item.comentario || ''}')" class="text-indigo-600 hover:text-indigo-900" ${item.estadoPago === 'ANULADO' ? 'disabled' : ''}>Editar</button>
                                <button onclick="handleAnularPago(${item.idPago})" class="text-red-600 hover:text-red-900 ml-2" ${item.estadoPago === 'ANULADO' ? 'disabled' : ''}>Anular</button>
                            </td>
                        </tr>`;
                });
            } catch (error) {
                listBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">${error.message || "Error al cargar datos."}</td></tr>`;
            }
        }

        async function handleAnularPago(pagoId) {
            if (!confirm(`¿Estás seguro de que quieres ANULAR el pago con ID ${pagoId}?`)) return;
            const formMessage = document.getElementById('messageBox');
            try {
                const response = await fetch(`/api/pagos/${pagoId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${jwtToken}` } });
                const result = await response.json();
                if (result.success) {
                    showMessage(formMessage, 'Pago anulado correctamente.', 'bg-green-100 text-green-700');
                    await loadPagos();
                } else {
                    showMessage(formMessage, result.message || 'Error al anular el pago.', 'bg-red-100 text-red-700');
                }
            } catch (error) {
                showMessage(formMessage, 'Error de conexión.', 'bg-red-100 text-red-700');
            }
        }

        async function handleEditPagoComentario(pagoId, currentComment) {
            const newComment = prompt("Editar comentario:", currentComment);
            if (newComment === null || newComment === currentComment) return;
            
            const formMessage = document.getElementById('messageBox');
            try {
                const response = await fetch(`/api/pagos/${pagoId}/comentario`, { 
                    method: 'PATCH', 
                    headers: { 'Content-Type': 'text/plain', 'Authorization': `Bearer ${jwtToken}` },
                    body: newComment
                });
                const result = await response.json();
                if (result.success) {
                    showMessage(formMessage, 'Comentario actualizado.', 'bg-green-100 text-green-700');
                    await loadPagos();
                } else {
                    showMessage(formMessage, result.message || 'Error al actualizar.', 'bg-red-100 text-red-700');
                }
            } catch (error) {
                showMessage(formMessage, 'Error de conexión.', 'bg-red-100 text-red-700');
            }
        }

        // Event Listeners para el formulario de pago
        document.getElementById('tipo_pago').addEventListener('change', actualizarInterfazPago);
        document.getElementById('cliente_servicio').addEventListener('change', actualizarMontoPago);
        document.getElementById('dias_pagar').addEventListener('input', actualizarMontoPago);
        document.querySelector('#payments-screen button[onclick="registrarPago()"]')
            .setAttribute('onclick', 'handleRegisterPago()');

    </script>
</body>
</html>